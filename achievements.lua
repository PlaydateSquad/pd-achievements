
--[[
	==prototype achievements library==
	This is an initial prototype implementation in order to help effect a standard.
	This prototype will have no strong error checks and be small in scope. Any
	  wider-scope implementation of the standard will be separate.

	At the time of writing /Shared is slightly non-functional, so a temporary
	test folder is being used.

	== planned usage ==

	Import the library using `import "achievements"
	The library has now created a global variable named "achievements".
	I hate this approach, but it's a prototype and this is how the playdate
	  does things because y'all are crazy.

	The user now needs to configure the library. Make a config table as so:

		local achievementConfig = {
			-- Technically, any string. We need to spell it out explicitly
			--   instead of using metadata.bundleID so that it won't get 
			--   mangled by online sideloading. Plus, this way multi-pdx
			--   games or demos can share achievements.
			gameID = "com.yourcompany.yourgame",
			-- These are optional, and will be auto-filled with metadata
			--   values if not specified here. This is also for multi-pdx
			--   games.
			name = "My Awesome Game",
			author = "You, Inc",
			description = "The next evolution in cranking technology.",
			-- And finally, a table of achievements.
			achievements = {
				{
					id = "test_achievement",
					name = "Achievement Name",
					description = "Achievement Description",
					is_secret = false,
					icon = "filepath" -- to be iterated on
					[more to be determined]
				},
			}
		}

	This table makes up the top-level data structure being saved to the shared
	json file. The gameID field determines the name of the folder it will
	be written to, rather than bundleID, to keep things consistent.

	The only thing that is truly required is the gameID field, because this is
	  necessary for identification. Everything else can be left blank, and it
	  will be auto-filled or simply absent in the case of achievement data.

	The user passes the config table to the library like so:
		achievements.initialize(achievementConfig)
	This function finishes populating the configuration table with metadata
	  if necessary, merges the achievement data with the saved list of granted
	  achievements, creates the shared folder and .json file with the new data,
	  and iterates over the achievement data in order to copy images given to
	  the shared folder.

	In order to grant an achievement to the player, run `achievements.grant(id)`
	  If this is a valid achievement id, it will key the id to the current epoch
	  second in the achievement save data.
	In order to revoke an achievement, run `achievements.revoke(id)`
	  If this is a valid achievement id, it will remove the id from the save
	  data keys.
	
	To save achievement data, run `achievements.save()`. This will perfom a merge
	  with the configuration data and write it to the shared .json file. Run this
	  function alongside other game-save functions when the game exits. Of course,
	  unfortunately, achievements don't respect save slots.

	==details==
	The achievements file in the game's save directory is the prime authority on active achievements.
	It contains nothing more than a map of achievement IDs which have been earned by the player to when they were earned.
	This should make it extremely easy to manage, and prevents other games from directly messing with achievement data.
	The achievement files in the /Shared/Achievements/bundleID folder are regenerated at game load and when saving.
	They are to be generated by serializing `module.achievements` along with `module.localData` and copying any images (when we get to those).
--]]

print("Achievements library initializing...")

local root_folder = "/Shared/Achievements/"
local achievement_folder = root_folder .. playdate.metadata.bundleID .. "/"
local datafile_name = "info.json"
local local_achievement_file = "Achievements.json"

-- If we wanted to ensure the game's "marker" folder was created on first run even if the developer
--   only imports the file, this is where it would go. But file.mkdir isn't working for me. -D

local module = {}

module.achievements = {}

local function load_data()
	local data = json.decodeFile(local_achievement_file)
	if not data then
		data = {}
	end
	module.localData = data
end

local function save_data()
	json.encodeToFile(local_achievement_file, false, module.localData)
end

--[[ Final Initialization Function ]]--
module.ready = function()

	load_data()
end

--[[ Achievement Management Functions ]]--

module.getInfo = function(achievement_id)
	for _, achievement in ipairs(module.achievements) do
		if achievement.id == achievement_id then
			return achievement
		end
	end
	return false
end

module.grant = function(achievment_id, display_style)
	local info =  module.getInfo(achievment_id)
	if not info then
		error("attempt to grant unconfigured achevement '" .. achievment_id .. "'", 2)
	end
	module.localData[achievment_id] = ( playdate.getSecondsSinceEpoch() )
	save_data()
	-- Drawing to come later...
	
end

module.revoke = function(achievment_id)
	local info =  module.getInfo(achievment_id)
	if not info then
		error("attempt to revoke unconfigured achevement '" .. achievment_id .. "'", 2)
	end
	module.localData[achievment_id] = nil
	save_data()
end

--[[ External Game Functions ]]--

module.gamePlayed = function(game_id)
	return playdate.file.isdir(root_folder .. game_id)
end

module.gameData = function(game_id)
	if not module.gamePlayed(game_id) then
		error("No game with ID '" .. game_id .. "' was found", 2)
	end
	return playdate.datastore.read(root_folder .. game_id .. datafile_name)
end


return module